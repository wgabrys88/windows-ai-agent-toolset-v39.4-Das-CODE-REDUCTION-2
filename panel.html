<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>FRANZ Panel</title>
<style>
:root {
  --bg:#0a0a0f; --card:#12121a; --hover:#1a1a25; --border:#2a2a3a;
  --text:#d0d0e0; --dim:#707088; --accent:#4a9eff;
  --green:#40c040; --red:#e04040; --orange:#e0a020; --purple:#c080ff;
  --mono:'Consolas','Courier New',monospace;
  --hdr:36px; --ctrl:32px; --debug:32px;
}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--text);font-family:'Segoe UI',system-ui,sans-serif;font-size:14px;overflow:hidden;height:100vh;width:100vw;}
.header{height:var(--hdr);border-bottom:1px solid var(--border);padding:0 16px;display:flex;align-items:center;gap:16px;}
.header h1{font-size:15px;font-weight:700;color:var(--accent);letter-spacing:2px;}
.dot{width:7px;height:7px;border-radius:50%;background:var(--red);transition:background .3s;display:inline-block;margin-right:4px;}
.dot.on{background:var(--green);box-shadow:0 0 5px var(--green);}
.header .info{margin-left:auto;font-size:11px;color:var(--dim);font-family:var(--mono);}
.header .info span{color:var(--text);}

.controls{height:var(--ctrl);padding:0 16px;border-bottom:1px solid var(--border);display:flex;gap:10px;align-items:center;font-size:11px;}
.controls label{display:flex;align-items:center;gap:4px;color:var(--dim);cursor:pointer;user-select:none;}
.controls input[type="checkbox"]{accent-color:var(--accent);}
.controls button{background:var(--card);border:1px solid var(--border);color:var(--text);padding:3px 10px;border-radius:4px;cursor:pointer;font-size:11px;}
.controls button:hover{background:var(--hover);border-color:var(--accent);}
.controls button.active{background:rgba(224,64,64,.15);border-color:var(--red);color:var(--red);}
.controls button.debug-active{background:rgba(224,160,32,.15);border-color:var(--orange);color:var(--orange);}

.debug-bar{display:none;height:var(--debug);padding:0 16px;border-bottom:1px solid var(--border);background:rgba(224,160,32,.04);align-items:center;gap:8px;font-size:11px;}
.debug-bar.visible{display:flex;}
.debug-bar button{background:var(--card);border:1px solid var(--border);color:var(--text);padding:2px 8px;border-radius:3px;cursor:pointer;font-size:10px;font-family:var(--mono);}
.debug-bar button:hover{background:var(--hover);border-color:var(--accent);}
.debug-bar button.run-btn{border-color:var(--green);color:var(--green);}
.debug-bar button.run-btn:hover{background:rgba(64,192,64,.15);}
.debug-bar .sep{width:1px;height:18px;background:var(--border);}
.debug-bar .lbl{color:var(--orange);font-weight:600;letter-spacing:1px;text-transform:uppercase;}
.debug-result{font-size:11px;color:var(--dim);margin-left:8px;font-family:var(--mono);}

.main{position:relative;width:100%;overflow:hidden;}
.q{position:absolute;overflow:hidden;display:flex;flex-direction:column;}
.q-hdr{height:22px;min-height:22px;padding:0 10px;display:flex;align-items:center;gap:10px;font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:1px;border-bottom:1px solid var(--border);user-select:none;}
.q-body{flex:1;overflow-y:auto;overflow-x:hidden;padding:8px 10px;font-family:var(--mono);font-size:12px;line-height:1.6;white-space:pre-wrap;word-break:break-word;}
.q-body.empty{color:var(--dim);font-style:italic;}
.q-body textarea{width:100%;height:100%;background:var(--bg);color:var(--text);border:1px solid var(--accent);border-radius:3px;padding:6px 8px;font-family:var(--mono);font-size:12px;line-height:1.6;resize:none;outline:none;}

#qLeft{left:0;top:0;border-right:1px solid var(--border);}
#qTop{top:0;border-bottom:1px solid var(--border);}
#qCanvas .q-body{padding:0;}

#qLeft .q-hdr{color:var(--accent);background:rgba(74,158,255,.06);}
#qTop .q-hdr{color:var(--green);background:rgba(64,192,64,.06);}
#qCanvas .q-hdr{color:var(--purple);background:rgba(192,128,255,.06);}

.tabs{margin-left:auto;display:flex;gap:6px;}
.tab{background:transparent;border:1px solid var(--border);color:var(--dim);padding:1px 8px;border-radius:999px;font-size:10px;cursor:pointer;text-transform:none;letter-spacing:0;font-family:var(--mono);}
.tab:hover{border-color:var(--accent);color:var(--text);}
.tab.on{border-color:var(--accent);color:var(--accent);background:rgba(74,158,255,.10);}

.cross-c{position:absolute;z-index:70;border-radius:50%;cursor:move;background:rgba(74,158,255,.25);border:1px solid rgba(74,158,255,.5);}
.cross-c:hover{background:rgba(74,158,255,.5);}

.meta{margin-top:8px;padding-top:6px;border-top:1px solid var(--border);font-size:11px;display:grid;grid-template-columns:auto 1fr;gap:1px 10px;}
.meta .k{color:var(--dim);} .meta .v{color:var(--text);}
.action-badge{display:inline-block;padding:1px 6px;margin:1px 2px;border-radius:3px;font-size:10px;font-weight:600;font-family:var(--mono);background:rgba(224,64,64,.15);color:var(--red);}
.err-block{margin-top:8px;padding:6px 8px;background:rgba(224,64,64,.05);border:1px solid rgba(224,64,64,.3);border-radius:3px;font-size:11px;color:var(--red);}

/* tools overlay */
.overlay{display:none;position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.95);z-index:200;flex-direction:column;align-items:center;padding:16px;}
.overlay.visible{display:flex;}
.overlay .toolbar{display:flex;gap:10px;margin-bottom:12px;align-items:center;flex-wrap:wrap;}
.overlay .toolbar button{background:var(--card);border:1px solid var(--border);color:var(--text);padding:4px 12px;border-radius:4px;cursor:pointer;font-size:12px;}
.overlay .toolbar button:hover{background:var(--hover);border-color:var(--accent);}

/* canvas */
.canvas-wrap{position:relative;width:100%;height:100%;background:var(--bg);}
.canvas-wrap canvas{display:block;width:100%;height:100%;image-rendering:pixelated;}
.canvas-status{position:absolute;bottom:4px;left:6px;font:10px/1 Consolas,monospace;color:rgba(255,255,255,.35);pointer-events:none;}

::-webkit-scrollbar{width:5px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px;}
</style>
</head>
<body>
<header class="header">
  <h1>FRANZ</h1>
  <div><span class="dot" id="dot"></span><span id="conn">Disconnected</span></div>
  <div class="info">
    Turns: <span id="sTurns">0</span> |
    Latency: <span id="sLat">--</span> |
    Err: <span id="sErr">0</span>
  </div>
</header>

<nav class="controls">
  <label><input type="checkbox" id="chkAuto" checked /> Auto-advance</label>
  <button id="btnPause">Resume</button>
  <button id="btnDebug">Debug</button>
  <button id="btnTools">Tools</button>
  <button id="btnClear">Clear</button>
</nav>

<div class="debug-bar" id="debugBar">
  <span class="lbl">Debug</span>
  <div class="sep"></div>
  <span style="color:var(--dim)">Prefill:</span>
  <button id="dbClick">click(500,500)</button>
  <button id="dbRClick">right_click(300,200)</button>
  <button id="dbDblClick">double_click(500,500)</button>
  <button id="dbDrag">drag(100,100,900,900)</button>
  <button id="dbWrite">write("hello")</button>
  <button id="dbRemember">remember("test")</button>
  <button id="dbRecall">recall()</button>
  <div class="sep"></div>
  <button id="dbRun" class="run-btn">Run Executor</button>
  <span class="debug-result" id="dbResult"></span>
</div>

<main class="main" id="main">
  <!-- LEFT: VLM input/output (tabbed) -->
  <section class="q" id="qLeft">
    <div class="q-hdr">
      <span id="leftHdr">VLM</span>
      <div class="tabs" id="tabs">
        <button class="tab" id="tabIn">Input</button>
        <button class="tab on" id="tabOut">Output</button>
      </div>
    </div>
    <div class="q-body empty" id="cLeft">(waiting)</div>
  </section>

  <!-- RIGHT TOP: executed + system data -->
  <section class="q" id="qTop">
    <div class="q-hdr">System</div>
    <div class="q-body empty" id="cTop">(waiting)</div>
  </section>

  <!-- RIGHT BOTTOM: canvas -->
  <section class="q" id="qCanvas">
    <div class="q-hdr">Canvas</div>
    <div class="q-body">
      <div class="canvas-wrap">
        <canvas id="c"></canvas>
        <div class="canvas-status" id="canvasStatus">waiting</div>
      </div>
    </div>
  </section>

  <!-- resize handle -->
  <div class="cross-c" id="crossC"></div>

  <!-- tools overlay -->
  <div class="overlay" id="toolsOverlay">
    <div class="toolbar">
      <span style="color:var(--accent);font-weight:600">Allowed Tools</span>
      <button id="toolsAll">Enable All</button>
      <button id="toolsNone">Disable All</button>
      <button id="toolsClose">Close</button>
    </div>
    <div id="toolsList" style="display:flex;flex-direction:column;gap:8px;padding:16px;font-size:13px"></div>
  </div>
</main>

<script>
"use strict";
(function(){
  function g(id){return document.getElementById(id);}
  function esc(s){return (s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");}
  function xhr(method,url,body,cb){
    var x=new XMLHttpRequest();
    x.open(method,url,true);
    if(body!==null) x.setRequestHeader("Content-Type","application/json");
    x.onload=function(){
      if(!cb) return;
      try{cb(JSON.parse(x.responseText));}catch(e){cb(null);}
    };
    x.onerror=function(){ if(cb) cb(null); };
    x.send(body!==null ? (typeof body==="string"? body: JSON.stringify(body)) : null);
  }
  function scrollBottom(el){ if(el) el.scrollTop = el.scrollHeight; }

  // ----- state -----
  var turns=[]; var cur=-1; var totLat=0; var nErr=0;
  var paused=true; var debugMode=false;
  var leftView="output"; // 'input'|'output'

  // ----- layout: 3 panes w/ cross-handle -----
  var ma=g("main"), qLeft=g("qLeft"), qTop=g("qTop"), qCanvas=g("qCanvas"), cc=g("crossC");
  var sx=0.55, sy=0.35, GAP=4;

  function layout(){
    var w=ma.offsetWidth, h=ma.offsetHeight; if(w<=0||h<=0) return;
    var fx=Math.max(0.15, Math.min(0.85, sx));
    var fy=Math.max(0.12, Math.min(0.85, sy));
    var divX=Math.round(w*fx), divY=Math.round(h*fy);
    var lw=Math.max(0, divX-GAP), rw=Math.max(0, w-divX-GAP);
    var th=Math.max(0, divY-GAP), bh=Math.max(0, h-divY-GAP);
    var rx=divX+GAP, by=divY+GAP;

    qLeft.style.cssText = "position:absolute;left:0;top:0;width:"+lw+"px;height:"+h+"px";
    qTop.style.cssText  = "position:absolute;left:"+rx+"px;top:0;width:"+rw+"px;height:"+th+"px";
    qCanvas.style.cssText = "position:absolute;left:"+rx+"px;top:"+by+"px;width:"+rw+"px;height:"+bh+"px";

    var cs=20;
    cc.style.width=cs+"px"; cc.style.height=cs+"px";
    cc.style.left=(divX-cs/2)+"px"; cc.style.top=(divY-cs/2)+"px";
  }

  (function(){
    var drag=false;
    cc.addEventListener("mousedown", function(e){
      e.preventDefault(); drag=true;
      document.body.style.cursor="move"; document.body.style.userSelect="none";
    });
    document.addEventListener("mousemove", function(e){
      if(!drag) return;
      var r=ma.getBoundingClientRect();
      sx=(e.clientX-r.left)/r.width;
      sy=(e.clientY-r.top)/r.height;
      layout();
    });
    document.addEventListener("mouseup", function(){
      if(drag){ drag=false; document.body.style.cursor=""; document.body.style.userSelect=""; }
    });
  })();

  function recalcHeight(){
    var extra = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--hdr'))
              + parseInt(getComputedStyle(document.documentElement).getPropertyValue('--ctrl'));
    if(g('debugBar').classList.contains('visible')) extra += parseInt(getComputedStyle(document.documentElement).getPropertyValue('--debug'));
    ma.style.height = (window.innerHeight - extra) + "px";
    layout();
  }
  window.addEventListener('resize', recalcHeight);
  recalcHeight();

  // ----- header stats / pause -----
  var dot=g('dot'), conn=g('conn'), sTurns=g('sTurns'), sLat=g('sLat'), sErr=g('sErr');
  function stats(){
    sTurns.textContent=String(turns.length);
    sLat.textContent = turns.length ? Math.round(totLat/turns.length)+"ms" : "--";
    sErr.textContent = String(nErr);
    if(nErr>0) sErr.style.color = "#e0a020";
  }
  function updPause(){
    var btn=g('btnPause');
    btn.textContent = paused ? "Resume" : "Pause";
    if(paused) btn.classList.add('active'); else btn.classList.remove('active');
  }

  // ----- left view tabs -----
  function setLeftView(v){
    leftView=v;
    g('tabIn').classList.toggle('on', v==='input');
    g('tabOut').classList.toggle('on', v==='output');
    renderLeft();
  }
  g('tabIn').addEventListener('click', function(){ if(!debugMode) setLeftView('input'); });
  g('tabOut').addEventListener('click', function(){ if(!debugMode) setLeftView('output'); });

  var cLeft=g('cLeft'), cTop=g('cTop');

  function renderLeft(){
    if(debugMode) return;
    if(cur<0 || cur>=turns.length){ cLeft.textContent='(waiting)'; cLeft.classList.add('empty'); return; }
    var e=turns[cur], req=e.request||{}, resp=e.response||{};
    var t = leftView==='input' ? (req.story_text||"") : (resp.vlm_text||"");
    if(t){
      cLeft.textContent=t; cLeft.classList.remove('empty');
      scrollBottom(cLeft);
    } else {
      cLeft.innerHTML='<span style="color:var(--dim)">(empty)</span>'; cLeft.classList.add('empty');
    }
    if(leftView==='output' && resp.error){
      cLeft.innerHTML += '\n<div class="err-block">'+esc(resp.error)+'</div>';
    }
  }

  function renderSystem(){
    if(cur<0 || cur>=turns.length){ cTop.textContent='(waiting)'; cTop.classList.add('empty'); return; }
    var e=turns[cur], req=e.request||{}, resp=e.response||{};
    var usage=resp.usage||{}, actions=e.actions||[];
    var meta='<div class="meta">';
    var items=[
      ['turn', e.turn],
      ['latency', Math.round(e.latency_ms||0)+'ms'],
      ['status', resp.status||'' ],
      ['prompt_tok', usage.prompt_tokens!=null?usage.prompt_tokens:'?'],
      ['compl_tok', usage.completion_tokens!=null?usage.completion_tokens:'?'],
      ['model', req.model||'' ],
      ['timestamp', e.timestamp||'' ]
    ];
    for(var i=0;i<items.length;i++){
      meta += '<div class="k">'+esc(String(items[i][0]))+'</div><div class="v">'+esc(String(items[i][1]))+'</div>';
    }
    meta += '</div>';

    if(actions.length){
      meta += '<div style="margin-top:6px;padding-top:4px;border-top:1px solid var(--border)">'
           +  '<span style="color:var(--red);font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:1px">Executed</span><br>';
      for(var j=0;j<actions.length;j++){
        var a=actions[j];
        meta += '<span class="action-badge">'+(j+1)+'. '+esc(a.name)+'('+(a.args||[]).join(', ')+')</span> ';
      }
      meta += '</div>';
    }
    if(resp.parse_error) meta += '<div class="err-block">Parse: '+esc(resp.parse_error)+'</div>';

    cTop.innerHTML=meta; cTop.classList.remove('empty');
  }

  function show(idx){
    if(idx<0||idx>=turns.length) return;
    cur=idx;
    if(debugMode){ setEditable(); }
    else { renderLeft(); renderSystem(); }
  }

  // ----- debug mode -----
  var btnDebug=g('btnDebug'), debugBar=g('debugBar'), dbResult=g('dbResult');
  function setEditable(){
    var txt='';
    if(cur>=0 && cur<turns.length){
      txt = ((turns[cur].response||{}).vlm_text)||'';
    }
    g('leftHdr').textContent='Debug';
    g('tabs').style.display='none';
    cLeft.innerHTML='<textarea id="dbTA">'+esc(txt)+'</textarea>';
    cLeft.classList.remove('empty');
  }
  function restoreFromDebug(){
    g('leftHdr').textContent='VLM';
    g('tabs').style.display='flex';
    renderLeft();
  }
  function enterDebug(){ debugMode=true; btnDebug.classList.add('debug-active'); debugBar.classList.add('visible'); recalcHeight(); setEditable(); }
  function exitDebug(){ debugMode=false; btnDebug.classList.remove('debug-active'); debugBar.classList.remove('visible'); recalcHeight(); restoreFromDebug(); renderSystem(); }
  btnDebug.addEventListener('click', function(){ debugMode ? exitDebug() : enterDebug(); });

  var prefills={
    dbClick:"I will click the center.\n\nclick(500, 500)\nclick(500, 500)",
    dbRClick:"I will open a context menu.\n\nright_click(300, 200)\nclick(300, 200)",
    dbDblClick:"I will open this item.\n\ndouble_click(500, 500)\nclick(500, 500)",
    dbDrag:"I will drag.\n\ndrag(100, 100, 900, 900)\nclick(900, 900)",
    dbWrite:"I will type some text.\n\nwrite(\"hello\")\nclick(500, 500)",
    dbRemember:"I will remember this.\n\nremember(\"test memory entry\")\nclick(500, 500)",
    dbRecall:"I will recall memory.\n\nrecall()\nclick(500, 500)"
  };
  Object.keys(prefills).forEach(function(id){
    g(id).addEventListener('click', function(){
      if(!debugMode) return;
      var ta=document.getElementById('dbTA');
      if(ta) ta.value = prefills[id];
    });
  });

  g('dbRun').addEventListener('click', function(){
    if(!debugMode) return;
    var ta=document.getElementById('dbTA');
    var raw=ta?ta.value:"";
    if(!raw.trim()){ dbResult.textContent='Nothing to execute'; dbResult.style.color='var(--red)'; return; }
    dbResult.textContent='Running...'; dbResult.style.color='var(--dim)';
    g('dbRun').disabled=true;
    xhr('POST','/debug/execute',{raw:raw}, function(d){
      g('dbRun').disabled=false;
      if(!d){ dbResult.textContent='Request failed'; dbResult.style.color='var(--red)'; return; }
      if(d.error){ dbResult.textContent='Error: '+d.error; dbResult.style.color='var(--red)'; return; }
      var executed=d.executed||[], malformed=d.malformed||[];
      dbResult.textContent='Executed: '+executed.length+' | Errors: '+malformed.length;
      dbResult.style.color = malformed.length? 'var(--orange)' : 'var(--green)';

      // show result in System pane
      var meta='<div class="meta">';
      meta += '<div class="k">source</div><div class="v">Debug executor</div>';
      meta += '<div class="k">executed</div><div class="v">'+esc(executed.join(', ')||'(none)')+'</div>';
      if(malformed.length) meta += '<div class="k">errors</div><div class="v" style="color:var(--red)">'+esc(malformed.join('; '))+'</div>';
      meta += '</div>';
      cTop.innerHTML=meta; cTop.classList.remove('empty');
    });
  });

  // ----- tools overlay -----
  var allTools=["click","right_click","double_click","drag","write","remember","recall"]; var enabledTools=allTools.slice();
  var toolsOv=g('toolsOverlay'), toolsList=g('toolsList');
  function renderTools(){
    toolsList.innerHTML='';
    allTools.forEach(function(t){
      var lbl=document.createElement('label');
      lbl.style.cssText='display:flex;align-items:center;gap:8px;color:var(--text);cursor:pointer;user-select:none';
      var cb=document.createElement('input');
      cb.type='checkbox'; cb.checked = enabledTools.indexOf(t)>=0;
      cb.style.accentColor='var(--accent)';
      cb.addEventListener('change', function(){
        if(cb.checked){ if(enabledTools.indexOf(t)<0) enabledTools.push(t); }
        else enabledTools = enabledTools.filter(function(x){return x!==t;});
        xhr('POST','/allowed_tools', enabledTools, function(){});
      });
      lbl.appendChild(cb); lbl.appendChild(document.createTextNode(t));
      toolsList.appendChild(lbl);
    });
  }
  g('btnTools').addEventListener('click', function(){
    toolsOv.classList.add('visible');
    xhr('GET','/allowed_tools', null, function(d){ if(Array.isArray(d)) enabledTools=d; renderTools(); });
  });
  g('toolsAll').addEventListener('click', function(){ enabledTools=allTools.slice(); renderTools(); xhr('POST','/allowed_tools', enabledTools, function(){}); });
  g('toolsNone').addEventListener('click', function(){ enabledTools=[]; renderTools(); xhr('POST','/allowed_tools', enabledTools, function(){}); });
  g('toolsClose').addEventListener('click', function(){ toolsOv.classList.remove('visible'); });

  // ----- controls -----
  var chkAuto=g('chkAuto');
  g('btnClear').addEventListener('click', function(){
    turns=[]; cur=-1; totLat=0; nErr=0; stats();
    cLeft.textContent='(waiting)'; cLeft.classList.add('empty');
    cTop.textContent='(waiting)'; cTop.classList.add('empty');
    if(debugMode) setEditable();
  });

  g('btnPause').addEventListener('click', function(){
    xhr('POST', paused?'/unpause':'/pause', {}, function(d){ if(!d) return; paused=!!d.paused; updPause(); });
  });

  function pollHealth(){
    xhr('GET','/health', null, function(d){ if(!d) return; paused=!!d.paused; updPause(); });
  }
  setInterval(pollHealth, 5000);
  pollHealth();

  // ----- SSE -----
  var es=null;
  function connect(){
    if(es) es.close();
    es=new EventSource('/events');
    es.onopen=function(){ dot.classList.add('on'); conn.textContent='Connected'; };
    es.onerror=function(){ dot.classList.remove('on'); conn.textContent='Reconnecting...'; };
    es.onmessage=function(evt){
      try{
        var d=JSON.parse(evt.data);
        if(d.type==='connected') return;
        turns.push(d);
        totLat += (d.latency_ms||0);
        if((d.response||{}).error) nErr++;
        stats();
        if(chkAuto.checked && !debugMode){
          leftView='output';
          g('tabIn').classList.toggle('on', false);
          g('tabOut').classList.toggle('on', true);
          show(turns.length-1);
        } else {
          if(cur<0) show(turns.length-1);
          else { renderLeft(); renderSystem(); }
        }
      }catch(e){}
    };
  }
  connect();

  // ----- integrated canvas (heatmap proxy) -----
  var canvas=g('c');
  var ctx=canvas.getContext('2d');
  var canvasStatus=g('canvasStatus');
  var lastSeq=-1;

  function submitAnnotated(seq, b64, attempt){
    attempt = attempt || 0;
    var x=new XMLHttpRequest();
    x.open('POST','/annotated', true);
    x.timeout=2000;
    x.setRequestHeader('Content-Type','application/json');
    function retry(){
      if(attempt>=6){ canvasStatus.textContent='annotate POST failed seq='+seq; return; }
      setTimeout(function(){ submitAnnotated(seq, b64, attempt+1); }, 200*(attempt+1));
    }
    x.onload=function(){ if(x.status!==200) retry(); };
    x.onerror=x.ontimeout=retry;
    x.send(JSON.stringify({seq:seq, image_b64:b64}));
  }

  function paintClickHeat(hc, px, py, r){
    var g=hc.createRadialGradient(px,py,0,px,py,r);
    g.addColorStop(0.0,'rgba(255, 40,  0, 0.88)');
    g.addColorStop(0.25,'rgba(255, 80,  0, 0.70)');
    g.addColorStop(0.55,'rgba(255, 120, 0, 0.35)');
    g.addColorStop(1.0,'rgba(255, 160, 0, 0.00)');
    hc.beginPath(); hc.arc(px,py,r,0,Math.PI*2); hc.fillStyle=g; hc.fill();
  }
  function paintDragHeat(hc, x0,y0,x1,y1,r){
    var dx=x1-x0, dy=y1-y0, len=Math.sqrt(dx*dx+dy*dy);
    paintClickHeat(hc,x0,y0,r); paintClickHeat(hc,x1,y1,r);
    if(len<2) return;
    var steps=Math.max(2, Math.round(len/(r*0.4)));
    for(var s=1;s<steps;s++){
      var t=s/steps; var mx=x0+dx*t; var my=y0+dy*t;
      var inner=hc.createRadialGradient(mx,my,0,mx,my,r*0.75);
      inner.addColorStop(0.0,'rgba(255, 60,  0, 0.55)');
      inner.addColorStop(0.5,'rgba(255, 100, 0, 0.25)');
      inner.addColorStop(1.0,'rgba(255, 140, 0, 0.00)');
      hc.beginPath(); hc.arc(mx,my,r*0.75,0,Math.PI*2); hc.fillStyle=inner; hc.fill();
    }
  }
  function drawHeat(actions, w, h){
    var heat=document.createElement('canvas'); heat.width=w; heat.height=h;
    var hc=heat.getContext('2d');
    hc.globalCompositeOperation='lighter';
    var baseR=Math.round(Math.min(w,h)*0.22);
    for(var i=0;i<actions.length;i++){
      var a=actions[i]||{}; var name=a.name||''; var args=a.args||[];
      if((name==='click'||name==='right_click'||name==='double_click') && args.length>=2){
        paintClickHeat(hc, args[0]*w/1000, args[1]*h/1000, baseR);
      } else if(name==='drag' && args.length>=4){
        paintDragHeat(hc, args[0]*w/1000,args[1]*h/1000,args[2]*w/1000,args[3]*h/1000, baseR);
      }
    }
    ctx.globalAlpha=1.0; ctx.drawImage(heat,0,0);
  }
  function drawClickMarker(px,py,name,idx){
    ctx.strokeStyle='rgba(255,255,255,0.9)'; ctx.lineWidth=1.5;
    ctx.beginPath(); ctx.arc(px,py,8,0,Math.PI*2); ctx.stroke();
    if(name==='double_click'){
      ctx.beginPath(); ctx.arc(px,py,13,0,Math.PI*2);
      ctx.strokeStyle='rgba(255,255,255,0.55)'; ctx.lineWidth=1; ctx.stroke();
    }
    ctx.strokeStyle='rgba(255,255,255,0.75)'; ctx.lineWidth=1;
    ctx.beginPath();
    ctx.moveTo(px-12,py); ctx.lineTo(px+12,py);
    ctx.moveTo(px,py-12); ctx.lineTo(px,py+12);
    ctx.stroke();
    ctx.fillStyle='rgba(255,255,255,0.95)';
    ctx.beginPath(); ctx.arc(px,py,2,0,Math.PI*2); ctx.fill();
    if(name==='right_click'){
      ctx.font='bold 8px Consolas,monospace'; ctx.fillStyle='rgba(255,255,255,0.9)'; ctx.fillText('R', px+11, py-5);
    }
    ctx.font='bold 8px Consolas,monospace'; ctx.fillStyle='rgba(255,255,255,0.9)'; ctx.fillText(String(idx), px+11, py+5);
  }
  function drawDragMarker(x0,y0,x1,y1,idx){
    ctx.strokeStyle='rgba(255,255,255,0.8)'; ctx.lineWidth=1.5;
    ctx.beginPath(); ctx.moveTo(x0,y0); ctx.lineTo(x1,y1); ctx.stroke();
    ctx.fillStyle='rgba(255,255,255,0.9)'; ctx.beginPath(); ctx.arc(x0,y0,3.5,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle='rgba(255,255,255,0.9)'; ctx.lineWidth=1.5; ctx.beginPath(); ctx.arc(x1,y1,5.5,0,Math.PI*2); ctx.stroke();
    var dx=x1-x0, dy=y1-y0, len=Math.sqrt(dx*dx+dy*dy);
    if(len>5){
      var nx=dx/len, ny=dy/len, al=Math.min(10, len*0.25);
      ctx.strokeStyle='rgba(255,255,255,0.9)'; ctx.lineWidth=1.5;
      ctx.beginPath();
      ctx.moveTo(x1,y1); ctx.lineTo(x1-nx*al+ny*al*0.5, y1-ny*al-nx*al*0.5);
      ctx.moveTo(x1,y1); ctx.lineTo(x1-nx*al-ny*al*0.5, y1-ny*al+nx*al*0.5);
      ctx.stroke();
    }
    ctx.font='bold 8px Consolas,monospace'; ctx.fillStyle='rgba(255,255,255,0.9)'; ctx.fillText(String(idx), x0+6, y0-4);
  }
  function drawMarkers(actions,w,h){
    for(var i=0;i<actions.length;i++){
      var a=actions[i]||{}; var name=a.name||''; var args=a.args||[];
      if((name==='click'||name==='right_click'||name==='double_click') && args.length>=2){
        drawClickMarker(args[0]*w/1000, args[1]*h/1000, name, i+1);
      } else if(name==='drag' && args.length>=4){
        drawDragMarker(args[0]*w/1000,args[1]*h/1000,args[2]*w/1000,args[3]*h/1000, i+1);
      }
    }
  }

  function processJob(j){
    var img=new Image();
    img.onload=function(){
      var w=img.naturalWidth, h=img.naturalHeight;
      canvas.width=w; canvas.height=h;
      ctx.drawImage(img,0,0);
      var actions=j.actions||[];
      if(actions.length){ drawHeat(actions,w,h); drawMarkers(actions,w,h); }
      canvas.toBlob(function(blob){
        var reader=new FileReader();
        reader.onload=function(){ submitAnnotated(j.seq, reader.result.split(',')[1]); };
        reader.readAsDataURL(blob);
      }, 'image/png');
      canvasStatus.textContent='turn '+j.seq+' | '+actions.length+' act';
    };
    img.onerror=function(){ canvasStatus.textContent='img error seq='+j.seq; submitAnnotated(j.seq,''); };
    img.src='data:image/png;base64,' + (j.image_b64||'');
  }

  function pollRenderJob(){
    var x=new XMLHttpRequest();
    x.open('GET','/render_job',true);
    x.timeout=1000;
    x.onload=function(){
      try{
        var d=JSON.parse(x.responseText);
        if(d && d.seq!==undefined && d.seq!==lastSeq){
          lastSeq=d.seq;
          processJob(d);
        }
      }catch(e){}
      setTimeout(pollRenderJob, 200);
    };
    x.onerror=x.ontimeout=function(){ setTimeout(pollRenderJob, 800); };
    x.send();
  }
  pollRenderJob();

})();
</script>
</body>
</html>